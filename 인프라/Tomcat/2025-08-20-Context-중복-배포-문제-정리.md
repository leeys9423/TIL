# 톰캣 Context 중복 배포 문제 정리

## 1. 발생한 문제

- **스케줄러가 한 번만 등록했는데 2번 실행되는 현상**
- 같은 URL에 대해 두 개의 서로 다른 경로로 접근 가능
  - `example.com/login` (루트 경로)
  - `example.com/myapp/login` (컨텍스트 경로)

## 2. 원인 분석

### 현재 설정 (server.xml)

```xml
<Host appBase="webapps" autoDeploy="true" name="localhost" unpackWARs="true">
<Context docBase="myapp" path="" reloadable="true" source="org.eclipse.jst.jee.server:myapp"/>
```

### 문제 상황

1. **자동 배포**: `autoDeploy="true"` → `webapps/myapp/`를 자동으로 `/myapp` 경로에 배포
2. **수동 배포**: `<Context path="" docBase="myapp"/>` → 같은 애플리케이션을 `/` (루트) 경로에 수동 배포

### 결과

- **같은 물리적 디렉토리(`webapps/myapp/`)를 참조하는 두 개의 웹 애플리케이션 컨텍스트가 생성**
- **핵심**: autoDeploy와 Context 태그가 **함께 동작**해서 중복 배포 발생
- 각각 독립적인 클래스로더, 스프링 컨텍스트, 스케줄러를 가짐
- 스케줄러가 두 번 실행됨

## 3. 톰캣 공식 문서 확인

### 톰캣에서 인정한 문제

> "If you want to deploy a WAR file or a directory using a context path that is not related to the base file name then one of the following options must be used to **prevent double-deployment**"

### Stack Overflow 확인 사례

> "If you add Context element in server.xml, and set autoDeploy="true", tomcat will do deployment twice."

## 4. 해결책

### 방법 1: Context 태그 제거 + ROOT.war 배포

```xml
<Host appBase="webapps" autoDeploy="true" name="localhost" unpackWARs="true">
<!-- Context 태그 제거 -->
```

- `webapps/myapp/` → `webapps/ROOT/`로 이름 변경
- 또는 WAR 파일을 `ROOT.war`로 배포

### 방법 2: autoDeploy 비활성화

```xml
<Host appBase="webapps" autoDeploy="false" name="localhost" unpackWARs="true">
<Context docBase="myapp" path="" reloadable="true"/>
```

### 방법 3: 외부 경로 사용

```xml
<Host appBase="webapps" autoDeploy="true" name="localhost" unpackWARs="true">
<Context docBase="/외부경로/myapp" path="" reloadable="true"/>
```

## 5. 용어 정리

### autoDeploy 속성

- **의미**: 톰캣이 webapps 폴더를 감시하여 새로운 WAR/폴더를 자동으로 웹 애플리케이션으로 배포
- **true**: webapps에 파일 추가 시 자동 배포 (무중단 배포 가능)
  - **Hot Deployment**: 톰캣 실행 중 WAR 파일 교체 → 짧은 다운타임 발생(세션 사용 시 세션 끊김)
- **false**: 수동 배포만 가능

## 6. 결론

- 톰캣의 **공식적으로 알려진 문제**
- **문제의 핵심**: `autoDeploy="true"`와 `<Context>` 태그를 **동시에** 같은 애플리케이션에 적용
- autoDeploy 혼자로는 문제 없음, Context 태그 혼자로도 문제 없음
- **하지만 둘이 함께 있으면** 같은 애플리케이션이 서로 다른 경로로 중복 배포됨
